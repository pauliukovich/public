# dhcp-online.ps1
# PowerShell 7
# ??????? ???? DHCP IPv4-????? ? TXT-??????

$OutFile = "C:\Windows\database\dhcp\dhcp-online.txt"

# ??????? ?????, ???? ?? ???
$dir = Split-Path $OutFile
if (!(Test-Path $dir)) {
    New-Item -ItemType Directory -Path $dir -Force | Out-Null
}

try {
    # ?????? DHCP (????? WinPSCompatSession ? pwsh 7)
    Import-Module DhcpServer -SkipEditionCheck -ErrorAction Stop
}
catch {
    Write-Host "?????? DhcpServer ?? ??????. ??????? RSAT / DHCP Tools." -ForegroundColor Red
    exit
}

# ??? DHCP-??????? (?????????)
$DhcpServer = $env:COMPUTERNAME

# ????? ??? IPv4 scope'?
$scopes = Get-DhcpServerv4Scope -ComputerName $DhcpServer

if (-not $scopes) {
    Write-Host "?? ??????? $DhcpServer ?? ??????? ?? ?????? IPv4 scope." -ForegroundColor Yellow
    exit
}

# ???????? ??? leases ?? ???? scope'??
$leases = foreach ($s in $scopes) {
    Get-DhcpServerv4Lease -ComputerName $DhcpServer -ScopeId $s.ScopeId
}

# ???? ?????? ?????? ???????? – ?????????????? ?????? ????
# $leases = $leases | Where-Object { $_.AddressState -eq 'Active' }

# ?????? ?????
$report = @()
$report += "DHCP ONLINE REPORT"
$report += "Server: $DhcpServer"
$report += "Generated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
$report += "-----------------------------------------------"
$report += ""

foreach ($l in $leases) {
    $report += "Scope:            $($l.ScopeId)"
    $report += "IP Address:       $($l.IPAddress)"
    $report += "Client Name:      $($l.HostName)"
    $report += "MAC (Unique ID):  $($l.ClientId)"
    $report += "Lease Expires:    $($l.LeaseExpiryTime)"
    $report += "State:            $($l.AddressState)"
    $report += "-----------------------------------------------"
}

# ????? ????
$report | Out-File -FilePath $OutFile -Encoding UTF8 -Force
